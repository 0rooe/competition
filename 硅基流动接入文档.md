# 后端硅基流动(SiliconFlow)模型接入文档

## 一、概述

本项目使用**硅基流动(SiliconFlow)**作为AI服务提供商，采用了与OpenAI兼容的API接口规范。主要使用的模型为 **Qwen/Qwen2-VL-72B-Instruct**，这是一个支持多模态(文本+图像)的大语言模型。

### 核心优势
- ✅ 支持文本对话
- ✅ 支持图像分析(Vision)
- ✅ 高性能、低延迟
- ✅ OpenAI兼容API

---

## 二、配置信息

### 2.1 配置文件位置
`src/main/resources/application.yml`

### 2.2 配置项说明

```yaml
siliconflow:
  api:
    base-url: https://api.siliconflow.cn/v1
    key: your key
    model: your model name
    timeout: 60000      # 超时时间(毫秒)
    max-tokens: 2000    # 最大生成token数
```

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| base-url | 硅基流动API基础地址 | https://api.siliconflow.cn/v1 |
| key | API密钥 | (需要自己申请) |
| model | 使用的模型名称 |自行选择|
| timeout | API调用超时时间 | 60000ms |
| max-tokens | 单次生成最大token数 | 2000 |

---

## 三、核心代码架构

### 3.1 配置类
**文件**: `config/SiliconFlowConfig.java`

```java
@Configuration
@ConfigurationProperties(prefix = "siliconflow.api")
public class SiliconFlowConfig {
    private String baseUrl;      // API地址
    private String key;          // API密钥
    private String model;        // 模型名称
    private Integer timeout;     // 超时时间
    private Integer maxTokens;   // 最大token数
    
    @Bean
    public WebClient siliconFlowWebClient() {
        return WebClient.builder()
            .baseUrl(baseUrl)
            .defaultHeader("Authorization", "Bearer " + key)
            .defaultHeader("Content-Type", "application/json")
            .codecs(configurer -> configurer.defaultCodecs()
                .maxInMemorySize(10 * 1024 * 1024))  // 10MB内存限制
            .build();
    }
}
```

**功能**:
- 读取配置文件中的硅基流动配置
- 创建预配置的WebClient Bean，自动注入Authorization头

---

### 3.2 请求与响应DTO

#### SiliconFlowRequest.java
```java
@Data
@Builder
public class SiliconFlowRequest {
    private String model;              // 模型名称
    private List<Message> messages;    // 对话消息列表
    private Double temperature;        // 温度参数(0-1)
    private Integer max_tokens;        // 最大生成token数
    private Boolean stream;            // 是否流式输出
    private Map<String, Object> tools; // 工具调用(可选)
    
    @Data
    @Builder
    public static class Message {
        private String role;     // system/user/assistant
        private String content;  // 消息内容
    }
}
```

#### SiliconFlowResponse.java
```java
@Data
public class SiliconFlowResponse {
    private String id;                 // 响应ID
    private String object;             // 对象类型
    private Long created;              // 创建时间戳
    private String model;              // 使用的模型
    private List<Choice> choices;      // 回复选项列表
    private Usage usage;               // token使用统计
    
    @Data
    public static class Choice {
        private Integer index;         // 选项索引
        private Message message;       // 消息内容
        private String finish_reason;  // 结束原因
    }
    
    @Data
    public static class Usage {
        private Integer prompt_tokens;      // 输入token数
        private Integer completion_tokens;  // 输出token数
        private Integer total_tokens;       // 总token数
    }
}
```

---

## 四、调用的硅基流动API接口

### 4.1 Chat Completions API (核心接口)

**接口地址**: `POST https://api.siliconflow.cn/v1/chat/completions`

**请求头**:
```
Authorization: Bearer {API_KEY}
Content-Type: application/json
```

**请求体**:
```json
{
  "model": "Qwen/Qwen2-VL-72B-Instruct",
  "messages": [
    {
      "role": "system",
      "content": "系统提示词"
    },
    {
      "role": "user",
      "content": "用户问题"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 2000,
  "stream": false
}
```

**响应体**:
```json
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1234567890,
  "model": "Qwen/Qwen2-VL-72B-Instruct",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "AI回复内容"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 100,
    "completion_tokens": 200,
    "total_tokens": 300
  }
}
```

---

## 五、业务功能实现

### 5.1 AI聊天服务 (AiChatService)

**文件**: `service/AiChatService.java`

#### 功能1: 简单文本对话
```java
public Mono<String> chatSimple(String userMessage) {
    // 构建请求
    Map<String, Object> requestBody = new HashMap<>();
    requestBody.put("model", model);
    requestBody.put("temperature", 0.7);
    requestBody.put("max_tokens", 2000);
    
    Map<String, Object> message = new HashMap<>();
    message.put("role", "user");
    message.put("content", userMessage);
    requestBody.put("messages", Arrays.asList(message));
    
    // 调用API
    return webClient.post()
        .uri(baseUrl + "/chat/completions")
        .header(HttpHeaders.AUTHORIZATION, "Bearer " + apiKey)
        .bodyValue(requestBody)
        .retrieve()
        .bodyToMono(String.class)
        .timeout(Duration.ofMillis(timeout));
}
```

**调用接口**: `POST /v1/chat/completions`  
**使用场景**: 普通AI对话

---

## 六、数据流转图

```
用户请求
   ↓
Controller (接收请求)
   ↓
Service (业务逻辑)
   ↓
构建SiliconFlowRequest
   ↓
WebClient发送HTTP请求
   ↓
POST https://api.siliconflow.cn/v1/chat/completions
   ↓
硅基流动服务器处理
   ↓
返回SiliconFlowResponse
   ↓
Service解析响应
   ↓
保存对话记录(可选)
   ↓
返回结果给前端
```
