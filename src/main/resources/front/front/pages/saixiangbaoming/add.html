<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>赛项报名</title>
	<link rel="stylesheet" href="../../layui/css/layui.css">
	<link rel="stylesheet" href="../../xznstatic/css/common.css" />
	<link rel="stylesheet" href="../../xznstatic/css/style.css" />
	<style>
		body {
			background-color: #f6f8fa;
		}

		.add-container {
			width: 1000px;
			margin: 40px auto;
			background: #fff;
			box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
			border-radius: 8px;
			padding: 40px;
		}

		.form-header {
			text-align: center;
			margin-bottom: 30px;
			border-bottom: 1px solid #eee;
			padding-bottom: 20px;
		}

		.form-header h2 {
			font-size: 24px;
			font-weight: 600;
			color: #333;
		}

		.layui-form-item {
			margin-bottom: 25px;
		}

		.layui-form-label {
			width: 120px;
			color: #666;
			font-weight: 500;
		}

		.layui-input-block {
			margin-left: 150px;
		}

		.layui-input,
		.layui-textarea {
			border-radius: 4px;
			border: 1px solid #ddd;
			transition: all 0.3s;
		}

		.layui-input:focus,
		.layui-textarea:focus {
			border-color: #1E9FFF;
			box-shadow: 0 0 0 2px rgba(30, 159, 255, 0.2);
		}

		.readonly-input {
			background-color: #f8f8f8;
			color: #999;
			cursor: not-allowed;
		}

		.btn-submit {
			background-color: #1E9FFF;
			border-radius: 4px;
			height: 40px;
			line-height: 40px;
			padding: 0 40px;
			font-size: 16px;
			border: none;
			transition: background 0.3s;
		}

		.btn-submit:hover {
			background-color: #0088ee;
		}

		.btn-reset {
			height: 40px;
			line-height: 40px;
			padding: 0 30px;
			border-radius: 4px;
			margin-left: 20px;
		}
	</style>
</head>

<body>
	<div id="app" v-cloak>
		<div class="add-container" :style="{display: formVisible ? 'block' : 'none'}" style="display: none;">
			<div class="form-header">
				<h2>赛项报名</h2>
			</div>

			<form class="layui-form" lay-filter="myForm">
				<input type="hidden" name="tuanduiRole" v-model="detail.tuanduiRole">
				<!-- ... existing form fields ... -->


				<div class="layui-form-item">
					<label class="layui-form-label">赛项名称</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.saixiangmingcheng" name="saixiangmingcheng" readonly
							class="layui-input readonly-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">类型</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.leixing" name="leixing" readonly
							class="layui-input readonly-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">级别</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.jibie" name="jibie" readonly
							class="layui-input readonly-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">报名费用</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.baomingfeiyong" name="baomingfeiyong" readonly
							class="layui-input readonly-input" style="color: #ff5722; font-weight: bold;">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">学号</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.xuehao" name="xuehao" readonly
							class="layui-input readonly-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">姓名</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.xingming" name="xingming" readonly
							class="layui-input readonly-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">报名日期</label>
					<div class="layui-input-block">
						<input type="text" name="baomingriqi" id="baomingriqi" autocomplete="off"
							class="layui-input readonly-input" readonly>
					</div>
				</div>



				<div class="layui-form-item" v-if="detail.leixing == '团队赛' && detail.tuanduiRole == '队长'">
					<label class="layui-form-label">团队名称</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.tuanduimingcheng" name="tuanduimingcheng"
							placeholder="请输入团队名称" class="layui-input">
					</div>
				</div>

				<div class="layui-form-item" v-if="detail.leixing == '团队赛' && detail.tuanduiRole == '队员'">
					<label class="layui-form-label">邀请码</label>
					<div class="layui-input-block">
						<input type="text" v-model="detail.invitationCode" name="invitationCode"
							placeholder="请输入队长提供的邀请码" class="layui-input">
					</div>
				</div>

				<div class="layui-form-item" v-if="detail.tuanduiRole != '队员'">
					<label class="layui-form-label">指导教师</label>
					<div class="layui-input-block">
						<select name="jiaoshigonghao" id="jiaoshigonghao" lay-filter="jiaoshigonghao"
							v-model="detail.jiaoshigonghao">
							<option value="">请选择指导教师</option>
							<option v-for="(item,index) in jiaoshiList" v-bind:key="index" :value="item.gonghao">{{
								item.xingming }}</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" v-else>
					<label class="layui-form-label">指导教师</label>
					<div class="layui-input-block">
						<input type="text" value="自动跟随队长" readonly class="layui-input readonly-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">备注/材料</label>
					<div class="layui-input-block">
						<textarea id="shenbaocailiao" name="shenbaocailiao" placeholder="请输入申报材料或备注信息"
							class="layui-textarea"></textarea>
					</div>
				</div>

				<div class="layui-form-item" style="margin-top: 40px; text-align: center;">
					<button class="layui-btn btn-submit" lay-submit lay-filter="*">提交报名</button>
				</div>
			</form>
		</div>
	</div>

	<script src="../../layui/layui.js"></script>
	<script src="../../js/vue.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../modules/config.js"></script>
	<script src="../../js/utils.js"></script>
	<script src="../../js/validate.js"></script>

	<script>
		var vue = new Vue({
			el: '#app',
			data: {
				detail: {
					saixiangmingcheng: '',
					leixing: '',
					jibie: '',
					baomingfeiyong: '',
					baomingriqi: '',
					shenbaocailiao: '',
					xuehao: '',
					xingming: '',
					jiaoshigonghao: '',
					jiaoshixingming: '',
					tuanduimingcheng: '',
					tuanduiRole: '',
					invitationCode: '',
				},
				jiaoshiList: [],
				backupDetail: {}, // Add backup object
				ro: {},
				formVisible: false, // Control form visibility
			},
			updated: function () {
				layui.form.render();
			},
			methods: {
				jump(url) { jump(url) }
			}
		});

		layui.use(['layer', 'element', 'http', 'jquery', 'form', 'laydate', 'tinymce', 'util'], function () {
			// ... existing modules ...
			var layer = layui.layer;
			var http = layui.http;
			var jquery = layui.jquery;
			var form = layui.form;
			var laydate = layui.laydate;
			var tinymce = layui.tinymce;
			var util = layui.util;

			// ... date/tinymce init ...
			// Date Picker
			laydate.render({
				elem: '#baomingriqi',
				value: new Date() // Default to today
			});

			// TinyMCE (Simplified configuration)
			var edit = tinymce.render({
				elem: "#shenbaocailiao",
				height: 300,
				width: '100%'
			});

			// Get User Info from Session
			var userTable = localStorage.getItem("userTable");
			http.request(`${userTable}/session`, 'get', {}, function (data) {
				if (data.data) {
					vue.detail.xuehao = data.data.xuehao;
					vue.detail.xingming = data.data.xingming;
					// Update backup when session data arrives
					vue.backupDetail.xuehao = data.data.xuehao;
					vue.backupDetail.xingming = data.data.xingming;
				}
			});

			// Get Teachers
			http.request('jiaoshi/list', 'get', {
				page: 1,
				limit: 100
			}, function (res) {
				vue.jiaoshiList = res.data.list;
				vue.$nextTick(() => {
					form.render('select');
				});
			});

			// Get Cross Table Data (Competition Info)
			if (http.getParam('corss')) {
				var obj = JSON.parse(localStorage.getItem('crossObj'));
				for (var o in obj) {
					if (o == 'saixiangmingcheng') vue.detail.saixiangmingcheng = obj[o];
					if (o == 'leixing') vue.detail.leixing = obj[o];
					if (o == 'jibie') vue.detail.jibie = obj[o];
					if (o == 'baomingfeiyong') vue.detail.baomingfeiyong = obj[o];
				}
				// Backup the initialized data (including cross data)
				vue.backupDetail = JSON.parse(JSON.stringify(vue.detail));

				// Trigger Team Check
				setTimeout(function () {
					checkTeamType();
				}, 300);
			} else {
				// Even if not cross, check
				setTimeout(function () {
					checkTeamType();
				}, 300);
			}

			// Submit
			form.on('submit(*)', function (data) {
				// ... submit logic ...
				data = data.field;

				// Force sync tuanduiRole from Vue to ensure it is sent correctly
				// as hidden inputs sometimes have synchronization issues with Layui
				data.tuanduiRole = vue.detail.tuanduiRole;

				// Get TinyMCE content
				var shenbaocailiao = tinymce.get('#shenbaocailiao').getContent();
				data.shenbaocailiao = shenbaocailiao;

				// Add UserID (Critical Fix)
				data.userid = localStorage.getItem('userid');

				// Set Teacher Name
				if (data.jiaoshigonghao) {
					let tea = vue.jiaoshiList.find(t => t.gonghao == data.jiaoshigonghao);
					if (tea) {
						data.jiaoshixingming = tea.xingming;
					}
				}

				http.requestJson('saixiangbaoming/add', 'post', data, function (res) {
					// Logic prioritized by Role to avoid ambiguity
					if (vue.detail.tuanduiRole == '队长') {
						// Captain: Show Invitation Code
						layer.open({
							type: 1, // Page layer
							title: false,
							closeBtn: 0,
							area: '400px',
							shade: 0.8,
							resize: false,
							id: 'LAY_invite_code', // ID
							content: `
                                <div style="background: #fff; border-radius: 4px; overflow: hidden; font-family: 'PingFang SC', 'Microsoft YaHei';">
                                    <div style="background: #1E9FFF; padding: 20px; text-align: center;">
                                        <h3 style="color: #fff; font-size: 18px; font-weight: 500; margin: 0;">团队创建成功</h3>
                                    </div>
                                    <div style="padding: 30px 20px; text-align: center;">
                                         <p style="color: #666; font-size: 14px; margin-bottom: 15px;">您的团队邀请码为</p>
                                         <div style="font-size: 32px; color: #1E9FFF; font-weight: bold; letter-spacing: 2px; margin-bottom: 20px;">
                                             ${res.invitationCode}
                                         </div>
                                         <p style="color: #999; font-size: 12px; margin-bottom: 30px;">请将此码分享给队员以便加入</p>
                                         <div style="display: flex; gap: 15px;">
                                             <button class="layui-btn layui-btn-normal" style="flex: 1; height: 40px; line-height: 40px; border-radius: 4px;" id="btn-copy">复制并返回</button>
                                         </div>
                                    </div>
                                </div>
                            `,
							success: function (layero, index) {
								layui.jquery('#btn-copy').on('click', function () {
									var input = document.createElement('input');
									input.setAttribute('value', res.invitationCode);
									document.body.appendChild(input);
									input.select();
									document.execCommand('copy');
									document.body.removeChild(input);
									layer.msg('复制成功', { time: 1000 });
									layer.close(index);
									back();
								});
							}
						});
					}
					else if (vue.detail.tuanduiRole == '队员') {
						// Member: Show Join Success Modal
						layer.open({
							type: 1,
							title: false,
							closeBtn: 0,
							area: '400px',
							shade: 0.8,
							resize: false,
							id: 'LAY_join_success',
							content: `
                                <div style="background: #fff; border-radius: 4px; overflow: hidden; font-family: 'PingFang SC', 'Microsoft YaHei';">
                                    <div style="background: #5FB878; padding: 20px; text-align: center;">
                                        <h3 style="color: #fff; font-size: 18px; font-weight: 500; margin: 0;">加入团队成功</h3>
                                    </div>
                                    <div style="padding: 30px 20px; text-align: center;">
                                         <div style="margin-bottom: 20px;">
                                            <i class="layui-icon layui-icon-ok-circle" style="font-size: 60px; color: #5FB878;"></i>
                                         </div>
                                         <p style="color: #666; font-size: 16px; margin-bottom: 30px;">您已成功加入团队</p>
                                         <div style="display: flex; gap: 15px;">
                                             <button class="layui-btn layui-btn-normal" style="flex: 1; height: 40px; line-height: 40px; border-radius: 4px; background-color: #5FB878;" id="btn-ok">确定并返回</button>
                                         </div>
                                    </div>
                                </div>
                            `,
							success: function (layero, index) {
								layui.jquery('#btn-ok').on('click', function () {
									layer.close(index);
									back();
								});
							}
						});
					}
					else {
						// Default: Individual
						layer.msg('报名成功！请前往个人后台查看', {
							time: 2000,
							icon: 6
						}, function () {
							back();
						});
					}
				});
				return false;
			});
		});

		// Helper to check team type and prompt
		function checkTeamType() {
			// Only show modal for Team Competition AND when role is not yet selected
			if (vue.detail.leixing == '团队赛' && !vue.detail.tuanduiRole) {
				layer.open({
					type: 1,
					title: false, // Close default title
					closeBtn: 0,
					area: '400px',
					shade: 0.6,
					id: 'LAY_team_modal',
					resize: false,
					content: `
                        <div style="background: #fff; border-radius: 4px; overflow: hidden; font-family: 'PingFang SC', 'Microsoft YaHei';">
                            <div style="background: #1E9FFF; padding: 20px; text-align: center;">
                                <h3 style="color: #fff; font-size: 18px; font-weight: 500; margin: 0;">团队赛报名</h3>
                            </div>
                            <div style="padding: 30px 20px; text-align: center;">
                                <p style="color: #666; font-size: 16px; margin-bottom: 30px;">
                                    本赛项为团队赛事<br>请选择您的参赛身份
                                </p>
                                <div style="display: flex; flex-direction: row; gap: 15px;">
                                    <button class="layui-btn layui-btn-normal" id="btn-captain" 
                                        style="flex: 1; height: 44px; font-size: 14px; border-radius: 4px; background: #1E9FFF;">
                                        创建团队 (队长)
                                    </button>
                                    <button class="layui-btn layui-btn-primary" id="btn-member" 
                                        style="flex: 1; height: 44px; font-size: 14px; border-radius: 4px; border: 1px solid #1E9FFF; color: #1E9FFF;">
                                        加入团队 (队员)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `,
					success: function (layero, index) {
						// Bind events manually to avoid Layui btn callback limitations with custom html
						layui.jquery('#btn-captain').on('click', function () {
							vue.detail.tuanduiRole = '队长';
							vue.formVisible = true;
							layer.close(index);
							layui.form.render();
						});
						layui.jquery('#btn-member').on('click', function () {
							vue.detail.tuanduiRole = '队员';
							vue.formVisible = true;
							layer.close(index);
							layui.form.render();
						});
					}
				});
			} else {
				// Not a team competition or already selected, show form immediately
				vue.formVisible = true;
				layui.form.render(); // Ensure render
			}
		}
	</script>
</body>

</html>