<!-- 个人中心 -->
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>个人中心</title>
	<link rel="stylesheet" href="../../layui/css/layui.css">
	<link rel="stylesheet" href="../../xznstatic/css/common.css" />
	<link rel="stylesheet" href="../../xznstatic/css/style.css" />
	<style>
		body {
			background-color: #f6f8fa;
		}

		.center-container {
			width: 1200px;
			margin: 40px auto;
			display: flex;
			background: #fff;
			box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
			border-radius: 8px;
			min-height: 600px;
			overflow: hidden;
		}

		/* Sidebar */
		.sidebar {
			width: 240px;
			background: #fff;
			border-right: 1px solid #eee;
			padding: 20px 0;
		}

		.sidebar .user-info {
			text-align: center;
			padding: 20px;
			border-bottom: 1px solid #eee;
			margin-bottom: 20px;
		}

		.sidebar .user-info img {
			width: 80px;
			height: 80px;
			border-radius: 50%;
			object-fit: cover;
			border: 2px solid #eee;
			margin-bottom: 10px;
		}

		.sidebar .user-info .username {
			font-size: 16px;
			font-weight: 600;
			color: #333;
		}

		.sidebar ul li {
			width: 100%;
		}

		.sidebar ul li a {
			display: block;
			padding: 15px 30px;
			color: #666;
			font-size: 15px;
			transition: all 0.3s;
			border-left: 4px solid transparent;
		}

		.sidebar ul li a:hover {
			background-color: #f6f8fa;
			color: #1E9FFF;
		}

		.sidebar ul li.active a {
			background-color: #e6f7ff;
			color: #1E9FFF;
			border-left-color: #1E9FFF;
		}

		/* Main Content */
		.main-content {
			flex: 1;
			padding: 40px;
		}

		.form-header {
			font-size: 20px;
			font-weight: bold;
			color: #333;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 1px solid #eee;
		}

		.layui-form-item {
			margin-bottom: 25px;
		}

		.layui-form-label {
			width: 100px;
			color: #666;
		}

		.layui-input-block {
			margin-left: 130px;
			max-width: 500px;
		}

		.layui-input {
			border-radius: 4px;
		}

		.layui-input:focus {
			border-color: #1E9FFF !important;
		}

		.btn-update {
			background-color: #1E9FFF;
			color: white;
			padding: 0 40px;
			height: 40px;
			line-height: 40px;
			border-radius: 20px;
			border: none;
			cursor: pointer;
			font-size: 15px;
			transition: bg 0.3s;
		}

		.btn-update:hover {
			background-color: #0088ee;
		}

		.btn-logout {
			background-color: #ff5722;
			color: white;
			padding: 0 40px;
			height: 40px;
			line-height: 40px;
			border-radius: 20px;
			border: none;
			cursor: pointer;
			font-size: 15px;
			margin-left: 20px;
		}
	</style>
</head>

<body>
	<div id="app" v-cloak>
		<div class="banner">
			<!-- Simplified Banner or keep existing carousel header -->
			<div class="layui-carousel" id="swiper" style="width: 100%;">
				<div carousel-item>
					<div v-for="(item,index) in swiperList" :key="index">
						<img :src="item.img" style="width: 100%; height: 100%; object-fit: cover;" />
					</div>
				</div>
			</div>
		</div>

		<div class="center-container">
			<!-- Left Sidebar -->
			<div class="sidebar">
				<div class="user-info">
					<img id="sidebar-avatar" src="../../xznstatic/img/avator.png"
						onerror="this.src='../../xznstatic/img/avator.png'">
					<div class="username">{{user.xingming}}</div>
				</div>
				<ul>
					<li class="active"><a href="javascript:void(0)">个人信息</a></li>
					<li v-for="(item,index) in centerMenu" :key="index" v-if="index > 0">
						<a :href="'javascript:jump(\''+item.url+'\')'">{{item.name}}</a>
					</li>
				</ul>
			</div>

			<!-- Right Content -->
			<div class="main-content">
				<div class="form-header">个人信息</div>

				<form class="layui-form" lay-filter="myForm">
					<input type="hidden" name="id" id="id" />

					<div class="layui-form-item">
						<label class="layui-form-label">头像</label>
						<div class="layui-input-block">
							<img id="tupianImg"
								style="width: 100px; height: 100px; border-radius: 4px; object-fit: cover; margin-bottom: 10px; border: 1px solid #ddd;"
								src="../../xznstatic/img/avator.png">
							<input type="hidden" id="tupian" name="tupian" />
							<div>
								<button type="button" class="layui-btn layui-btn-sm layui-btn-normal" id="tupianUpload">
									<i class="layui-icon">&#xe67c;</i> 上传头像
								</button>
							</div>
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">学号</label>
						<div class="layui-input-block">
							<input type="text" name="xuehao" placeholder="学号" autocomplete="off" class="layui-input"
								readonly style="background: #f5f5f5;">
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">姓名</label>
						<div class="layui-input-block">
							<input type="text" name="xingming" placeholder="姓名" autocomplete="off" class="layui-input">
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">密码</label>
						<div class="layui-input-block">
							<input type="password" name="mima" placeholder="密码" autocomplete="off" class="layui-input">
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">性别</label>
						<div class="layui-input-block">
							<select name="xingbie" id="xingbie">
								<option value="">请选择</option>
								<option v-for="(item,index) in xingbie" :key="index" :value="item">{{item}}</option>
							</select>
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">手机</label>
						<div class="layui-input-block">
							<input type="text" name="shouji" placeholder="手机" autocomplete="off" class="layui-input">
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">邮箱</label>
						<div class="layui-input-block">
							<input type="text" name="youxiang" placeholder="邮箱" autocomplete="off" class="layui-input">
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">身份证</label>
						<div class="layui-input-block">
							<input type="text" name="shenfenzheng" placeholder="身份证" autocomplete="off"
								class="layui-input">
						</div>
					</div>

					<div class="layui-form-item" style="margin-top: 40px;">
						<div class="layui-input-block">
							<button class="btn-update" lay-submit lay-filter="*">更新信息</button>
							<button @click="logout" type="button" class="btn-logout">退出登录</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="../../layui/layui.js"></script>
	<script src="../../js/vue.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../modules/config.js"></script>
	<script src="../../js/utils.js"></script>
	<script src="../../js/validate.js"></script>

	<script>
		var vue = new Vue({
			el: '#app',
			data: {
				swiperList: [],
				xingbie: ['男', '女'],
				centerMenu: centerMenu,
				user: {}
			},
			updated: function () {
				layui.form.render(null, 'myForm');
			},
			methods: {
				jump(url) {
					jump(url)
				},
				logout() {
					localStorage.removeItem('Token');
					localStorage.removeItem('role');
					localStorage.removeItem('sessionTable');
					localStorage.removeItem('adminName');
					localStorage.removeItem('userid');
					localStorage.removeItem('userTable');
					localStorage.removeItem('iframeUrl');
					window.parent.location.href = '../login/login.html';
				}
			}
		});

		layui.use(['layer', 'element', 'carousel', 'http', 'jquery', 'form', 'upload'], function () {
			var layer = layui.layer;
			var element = layui.element;
			var carousel = layui.carousel;
			var http = layui.http;
			var jquery = layui.jquery;
			var form = layui.form;
			var upload = layui.upload;

			// Carousel
			http.request('config/list', 'get', { page: 1, limit: 5 }, function (res) {
				if (res.data.list.length > 0) {
					let swiperList = [];
					res.data.list.forEach(element => {
						if (element.value != null) swiperList.push({ img: element.value });
					});
					vue.swiperList = swiperList;
					vue.$nextTick(() => {
						carousel.render({
							elem: '#swiper',
							width: '100%',
							height: '400px',
							anim: 'fade',
							autoplay: 'true',
							interval: '4000'
						});
					})
				}
			});

			// Upload
			var tupianUpload = upload.render({
				elem: '#tupianUpload',
				url: http.baseurl + 'file/upload',
				headers: { Token: localStorage.getItem('Token') },
				accept: 'images',
				before: function () { layer.load(1); },
				done: function (res) {
					layer.closeAll();
					if (res.code == 0) {
						layer.msg("上传成功", { time: 2000, icon: 6 });
						var url = http.baseurl + 'upload/' + res.file;
						jquery('#tupian').val(url);
						jquery('#tupianImg').attr('src', url);
					} else {
						layer.msg(res.msg, { time: 2000, icon: 5 });
					}
				},
				error: function () {
					layer.closeAll();
					layer.msg("请求接口异常", { time: 2000, icon: 5 });
				}
			});

			// Load User Info
			let table = localStorage.getItem("userTable");
			if (!table) {
				layer.msg('请先登录', { time: 2000, icon: 5 }, function () {
					window.parent.location.href = '../login/login.html';
				});
			}

			http.request(`${table}/session`, 'get', {}, function (data) {
				vue.user = data.data;
				form.val("myForm", data.data);
				if (data.data.tupian) {
					jquery("#tupianImg").attr("src", data.data.tupian);
					jquery("#sidebar-avatar").attr("src", data.data.tupian);
				}
			});

			// Submit
			form.on('submit(*)', function (data) {
				data = data.field;
				if (!data.xuehao) { layer.msg('学号不能为空', { icon: 5 }); return false; }
				if (!data.mima) { layer.msg('密码不能为空', { icon: 5 }); return false; }
				if (!data.xingming) { layer.msg('姓名不能为空', { icon: 5 }); return false; }

				if (data.shouji && !isMobile(data.shouji)) { layer.msg('手机应输入手机格式', { icon: 5 }); return false; }
				if (data.youxiang && !isEmail(data.youxiang)) { layer.msg('邮箱应输入邮箱格式', { icon: 5 }); return false; }
				if (data.shenfenzheng && !isIdentity(data.shenfenzheng)) { layer.msg('身份证应输入身份证格式', { icon: 5 }); return false; }

				http.requestJson(table + '/update', 'post', data, function (res) {
					layer.msg('修改成功', { time: 2000, icon: 6 }, function () {
						window.location.reload();
					});
				});
				return false;
			});
		});
	</script>
</body>

</html>